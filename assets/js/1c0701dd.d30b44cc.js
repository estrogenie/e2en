"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6953],{96578:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"middleware","title":"Middleware","description":"Middleware intercepts network traffic between clients and servers. Use it for logging, validation, rate limiting, or data transformation.","source":"@site/docs/middleware.md","sourceDirName":".","slug":"/middleware","permalink":"/e2en/docs/middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/estrogenie/e2en/edit/master/docs/middleware.md","tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"sidebar_position":9},"sidebar":"defaultSidebar","previous":{"title":"Utilities","permalink":"/e2en/docs/utilities"},"next":{"title":"Type Safety","permalink":"/e2en/docs/type-safety"}}');var l=r(74848),a=r(28453);const s={sidebar_position:9},t="Middleware",d={},c=[{value:"Configuration",id:"configuration",level:2},{value:"Inbound Middleware",id:"inbound-middleware",level:2},{value:"Signature",id:"signature",level:3},{value:"Example: Logging",id:"example-logging",level:3},{value:"Example: Rate Limiting",id:"example-rate-limiting",level:3},{value:"Example: Validation",id:"example-validation",level:3},{value:"Outbound Middleware",id:"outbound-middleware",level:2},{value:"Signature",id:"signature-1",level:3},{value:"Example: Serialization",id:"example-serialization",level:3},{value:"Example: Filtering Sensitive Data",id:"example-filtering-sensitive-data",level:3},{value:"Middleware Chain",id:"middleware-chain",level:2},{value:"Complete Example",id:"complete-example",level:2},{value:"Best Practices",id:"best-practices",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,a.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"middleware",children:"Middleware"})}),"\n",(0,l.jsx)(n.p,{children:"Middleware intercepts network traffic between clients and servers. Use it for logging, validation, rate limiting, or data transformation."}),"\n",(0,l.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,l.jsxs)(n.p,{children:["Pass middleware to ",(0,l.jsx)(n.code,{children:"e2en.Run()"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-lua",children:"e2en.Run({\n    Middleware = {\n        Inbound = { validateMiddleware, logMiddleware },\n        Outbound = { serializeMiddleware },\n    }\n})\n"})}),"\n",(0,l.jsx)(n.h2,{id:"inbound-middleware",children:"Inbound Middleware"}),"\n",(0,l.jsxs)(n.p,{children:["Inbound middleware intercepts ",(0,l.jsx)(n.strong,{children:"client \u2192 server"})," remote function calls."]}),"\n",(0,l.jsx)(n.h3,{id:"signature",children:"Signature"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-lua",children:"function(player: Player, serviceName: string, methodName: string, args: {any}): (boolean, {any})\n"})}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Parameter"}),(0,l.jsx)(n.th,{children:"Description"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"player"})}),(0,l.jsx)(n.td,{children:"The player making the request"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"serviceName"})}),(0,l.jsx)(n.td,{children:"Name of the service being called"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"methodName"})}),(0,l.jsx)(n.td,{children:"Name of the method being called"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"args"})}),(0,l.jsx)(n.td,{children:"Arguments passed by the client"})]})]})]}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Return"}),(0,l.jsx)(n.th,{children:"Description"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"boolean"})}),(0,l.jsxs)(n.td,{children:[(0,l.jsx)(n.code,{children:"true"})," to continue, ",(0,l.jsx)(n.code,{children:"false"})," to drop the request"]})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"{any}"})}),(0,l.jsx)(n.td,{children:"The (possibly modified) arguments to pass forward"})]})]})]}),"\n",(0,l.jsx)(n.h3,{id:"example-logging",children:"Example: Logging"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-lua",children:'local function logMiddleware(player, serviceName, methodName, args)\n    print(string.format(\n        "[%s] %s called %s:%s",\n        os.date("%H:%M:%S"),\n        player.Name,\n        serviceName,\n        methodName\n    ))\n    return true, args\nend\n'})}),"\n",(0,l.jsx)(n.h3,{id:"example-rate-limiting",children:"Example: Rate Limiting"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-lua",children:'local rateLimits = {}\nlocal RATE_LIMIT = 10  -- calls per second\n\nlocal function rateLimitMiddleware(player, serviceName, methodName, args)\n    local key = player.UserId .. ":" .. serviceName .. ":" .. methodName\n    local now = os.clock()\n\n    local history = rateLimits[key] or {}\n\n    -- Remove old entries\n    local newHistory = {}\n    for _, timestamp in history do\n        if now - timestamp < 1 then\n            table.insert(newHistory, timestamp)\n        end\n    end\n\n    if #newHistory >= RATE_LIMIT then\n        warn(player.Name, "rate limited on", serviceName .. ":" .. methodName)\n        return false, {}\n    end\n\n    table.insert(newHistory, now)\n    rateLimits[key] = newHistory\n\n    return true, args\nend\n'})}),"\n",(0,l.jsx)(n.h3,{id:"example-validation",children:"Example: Validation"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-lua",children:"local function validateMiddleware(player, serviceName, methodName, args)\n    -- Check if player is still valid\n    if not player.Parent then\n        return false, {}\n    end\n\n    -- Check if player is banned\n    if bannedPlayers[player.UserId] then\n        return false, {}\n    end\n\n    return true, args\nend\n"})}),"\n",(0,l.jsx)(n.h2,{id:"outbound-middleware",children:"Outbound Middleware"}),"\n",(0,l.jsxs)(n.p,{children:["Outbound middleware intercepts ",(0,l.jsx)(n.strong,{children:"server \u2192 client"})," signals and property updates."]}),"\n",(0,l.jsx)(n.h3,{id:"signature-1",children:"Signature"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-lua",children:"function(player: Player?, serviceName: string, signalName: string, args: {any}): (boolean, {any})\n"})}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Parameter"}),(0,l.jsx)(n.th,{children:"Description"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"player"})}),(0,l.jsxs)(n.td,{children:["Target player (",(0,l.jsx)(n.code,{children:"nil"})," for FireAll)"]})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"serviceName"})}),(0,l.jsx)(n.td,{children:"Name of the service"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"signalName"})}),(0,l.jsx)(n.td,{children:"Name of the signal or property"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"args"})}),(0,l.jsx)(n.td,{children:"Data being sent"})]})]})]}),"\n",(0,l.jsx)(n.h3,{id:"example-serialization",children:"Example: Serialization"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-lua",children:'local function serializeMiddleware(player, serviceName, signalName, args)\n    -- Convert Vector3 to table for network efficiency\n    local processed = {}\n    for i, arg in args do\n        if typeof(arg) == "Vector3" then\n            processed[i] = { x = arg.X, y = arg.Y, z = arg.Z }\n        else\n            processed[i] = arg\n        end\n    end\n    return true, processed\nend\n'})}),"\n",(0,l.jsx)(n.h3,{id:"example-filtering-sensitive-data",children:"Example: Filtering Sensitive Data"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-lua",children:'local function filterMiddleware(player, serviceName, signalName, args)\n    -- Don\'t send admin data to non-admins\n    if signalName == "AdminData" then\n        if not player or not player:GetAttribute("IsAdmin") then\n            return false, {}\n        end\n    end\n    return true, args\nend\n'})}),"\n",(0,l.jsx)(n.h2,{id:"middleware-chain",children:"Middleware Chain"}),"\n",(0,l.jsx)(n.p,{children:"Middleware runs in array order. Each middleware receives the output of the previous one."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-lua",children:"Middleware = {\n    Inbound = { first, second, third },\n}\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"Request arrives\n      \u2502\n      \u25bc\n  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502  first  \u2502 \u2500\u2500 returns true, modifiedArgs1\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502\n      \u25bc\n  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502 second  \u2502 \u2500\u2500 returns true, modifiedArgs2\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502\n      \u25bc\n  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502  third  \u2502 \u2500\u2500 returns true, finalArgs\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502\n      \u25bc\n  Handler called with finalArgs\n"})}),"\n",(0,l.jsxs)(n.p,{children:["If any middleware returns ",(0,l.jsx)(n.code,{children:"false"}),", the chain stops and the request is dropped:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"Request arrives\n      \u2502\n      \u25bc\n  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502  first  \u2502 \u2500\u2500 returns true, args\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502\n      \u25bc\n  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  \u2502 second  \u2502 \u2500\u2500 returns false, {}\n  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2502\n      \u25bc\n  Request dropped (handler never called)\n"})}),"\n",(0,l.jsx)(n.h2,{id:"complete-example",children:"Complete Example"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-lua",children:'-- Loader.server.luau\nlocal ServerScriptService = game:GetService("ServerScriptService")\nlocal Types = require(ServerScriptService.e2en.Types)\n\nlocal e2en: Types.e2enServer = require(ServerScriptService.e2en) :: any\n\n-- Rate limiting state\nlocal callHistory = {}\n\nlocal function rateLimitMiddleware(player, serviceName, methodName, args)\n    local key = tostring(player.UserId)\n    local now = os.clock()\n\n    callHistory[key] = callHistory[key] or {}\n    local history = callHistory[key]\n\n    -- Clean old entries\n    for i = #history, 1, -1 do\n        if now - history[i] > 1 then\n            table.remove(history, i)\n        end\n    end\n\n    -- Check limit\n    if #history >= 30 then\n        return false, {}\n    end\n\n    table.insert(history, now)\n    return true, args\nend\n\nlocal function logMiddleware(player, serviceName, methodName, args)\n    print(string.format(\n        "[RPC] %s -> %s:%s (%d args)",\n        player.Name,\n        serviceName,\n        methodName,\n        #args\n    ))\n    return true, args\nend\n\nlocal function sanitizeMiddleware(player, serviceName, signalName, args)\n    -- Remove internal fields before sending to clients\n    local cleaned = {}\n    for i, arg in args do\n        if type(arg) == "table" then\n            local copy = table.clone(arg)\n            copy._internal = nil\n            copy._debug = nil\n            cleaned[i] = copy\n        else\n            cleaned[i] = arg\n        end\n    end\n    return true, cleaned\nend\n\ne2en.Run({\n    Middleware = {\n        Inbound = {\n            rateLimitMiddleware,\n            logMiddleware,\n        },\n        Outbound = {\n            sanitizeMiddleware,\n        },\n    }\n})\n'})}),"\n",(0,l.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Keep middleware fast"})," - It runs on every network call"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Return early"})," - Check failure conditions first"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Don't yield"})," - Middleware should be synchronous"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Clean up state"})," - For rate limiters, periodically remove old entries"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Log sparingly"})," - Excessive logging impacts performance"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Order matters"})," - Put validation before logging to avoid logging invalid requests"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(o,{...e})}):o(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>t});var i=r(96540);const l={},a=i.createContext(l);function s(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);